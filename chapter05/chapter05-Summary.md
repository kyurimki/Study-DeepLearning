# 5. 오차역전파법
- 신경망의 가중치 매개변수의 기울기를 구하는 데에 수치 미분 사용
- 수치 미분은 단순, 구현하기 쉽지만 계산 시간이 오래 걸린다는 단점
- **오차역전파법 backpropagation**으로 가중치 매개변수의 기울기 효율적 계산
- 오차역전파법 이해하는 방법에는 수식과 계산 그래프 2가지가 있다.
## 5.1 계산 그래프(computational graph)
- 계산 과정을 그래프로 표현
- 복수의 node와 edge(node 사이의 직선)로 표현됨.
### 5.1.1 계산 그래프로 풀다
- 계산 과정을 노드와 화살표로 표현
	- 노드는 원으로 표기, 원 안에 연산 내용을 적음.
	- 계산 결과를 화살표 위에 적어 각 노드의 계산 결과가 왼쪽에서 오른쪽으로 전해지게 한다.
1. 문제 1. 현빈 군은 슈퍼에서 1개에 100원인 사과를 2개 샀습니다. 이때 지불 금액을 구하세요. 단, 소비세가 10% 부과됩니다.

![image](https://user-images.githubusercontent.com/61455647/115502537-06fb2c00-a2b0-11eb-985d-1ffd1af23ebf.png)

-  [×2]와 [×1.1]를 각각 하나의 연산으로 취급해 원 안에 표기
- 처음에 사과의 100원이 [×2] 노드로 흐흐고, 200원이 되어 다음 노드로 전달
- 200원이 [×1.1] 노드를 거쳐 220원이 됨
- => 최종 답: 220원

![image](https://user-images.githubusercontent.com/61455647/115502851-8be64580-a2b0-11eb-82d7-76bc2f55b31a.png)

- 곱셈인 [×]만을 연산으로 생각할 수 있음 -> 2와 1.1은 각각 사과의 개수와 소비세 변수가 되어 원 밖에 표기

2. 문제2. 현빈 군은 슈퍼에서 사과를 2개, 귤을 3개 샀습니다. 사과는 1개에 100원, 귤은 1개 150원입니다. 소비세가 10%일 때 지불 금액을 구하세요.

![image](https://user-images.githubusercontent.com/61455647/115503526-84736c00-a2b1-11eb-8558-25b77a55afbd.png)

- 덧셈 노드인 [+]가 새로 등장해 사과와 귤의 금액 합산

- 계산 그래프를 이용한 문제풀이는 다음 흐름으로 진행된다.
	1. 계산 그래프를 구성한다.
	2. 그래프에서 계산을 왼쪽에서 오른쪽으로 진행한다. -> 순전파(forward propagation)
	- **역전파 backward propagation**: 오른쪽에서 왼쪽으로의 전파

### 5.1.2 국소적 계산
- 계산 그래프의 특징은 **국소적 계산**을 전파해 최종 결과를 얻음
	- 국소적: 직접 관계된 작은 범위
	- -> 국소적 계산: 전체에서 어떤 일이 벌어지든 관계없이 자신과 관계된 정보만으로 결과를 출력할 수 있음

![image](https://user-images.githubusercontent.com/61455647/115504559-19c33000-a2b3-11eb-956b-85d97219a8f7.png)

- 여러 식품을 구입해 총 금액 4000원
- 각 노드에서의 계산은 국소적 계산
	- ex. 사과 + 이외 물품 값의 계산(200 + 4000 -> 4200)에서 4000이라는 숫자가 어떻게 계산되었는가와 관계 없이, 두 숫자를 더하면 된다.

- 각 노드는 자신 관련 계산 외에 신경 쓸 필요가 없음
- => 계산 그래프는 국소적 계산에 집중
- 전체 계산이 복잡하더라도 각 단계에서 하는 일은 해당 노드의 국소적 계산임
- 국소적 계산은 단순하지만, 결과를 전달해 전체를 구성하는 복잡한 계산을 할 수 있음

### 5.1.3 왜 계산 그래프로 푸는가?
- 계산 그래프의 이점
	- 국소적 계산: 전체가 아무리 복잡해도 각 노드에서 단순한 계산에 집중해 문제를 단순화할 수 있음
	- 중간 계산 결과를 모두 보관 가능
		- ex. 사과 2개까지 계산했을 때의 금액 200원
		- ex. 소비세 더하기 전의 금액 650원
	- **역전파를 통해 미분을 효율적으로 계산 가능**
- ex. 문제 1. 사과 2개를 사서 소비세를 포함한 최종금액 구하기
	- -> 사과 가격이 오르면 최종 금액에 어떤 영향을 끼치는가 = 사과 가격에 대한 지불 금액의 미분
	- 사과 값이 *x*, 지불 금액이 *L*일 때 *∂L/∂x*: 사과 값이 아주 조금 올랐을 때 지불 금액이 얼마나 증가하는가
	- -> 계산 그래프에서 역전파로 구할 수 있음

![image](https://user-images.githubusercontent.com/61455647/115506066-6445ac00-a2b5-11eb-9274-0dbad2f0a2fa.png)
- 역전파는 순전파와 반대 방향의 화살표로 표시
- 국소적 미분을 전달, 미분 값을 화살표 아래에 표기
- 1 -> 1.1 -> 2.2 순으로 미분값 전달 = 사과 값이 아주 조금 오르면 최종 금액은 그 아주 작은 값의 2.2배만큼 인상
- => 계산 그래프의 이점은 순전파와 역전파를 활용해 각 변수의 미분을 효율적으로 구할 수 있음
## 5.2 연쇄법칙
- 역전파는 국소적인 미분을 순방향과 반대로 전달 by **연쇄법칙 chain rule**
### 5.2.1 계산 그래프의 역전파
![image](https://user-images.githubusercontent.com/61455647/115507825-92c48680-a2b7-11eb-98f8-936a2b44a572.png)
- *y = f(x)* 계산의 역전파 계산
	- 신호 E * 노드의 국소적 미분(*∂y/∂x*)을 다음 노드에 전달
		- 국소적 미분: 순전파 때의 *y = f(x)* 계산의 미분 -> *x*에 대한 *y*의 미분(*∂y/∂x*)
		- ex. *y = f(x) = x^2*이면 *∂y/∂x = 2x*
### 5.2.2 연쇄법칙이란?
- **함성 함수**: 여러 함수로 구성된 함수
- 연쇄법칙
	- 함성 함수의 미분에 대한 성질
	- => 합성 함수의 미분은 함성 함수를 구성하는 각 함수의 미분의 곱으로 나타낼 수 있다.

![image](https://user-images.githubusercontent.com/61455647/115509360-4d08bd80-a2b9-11eb-81f6-e87220ff8f02.png)

- 연쇄법칙에 의해, *∂z/∂x*(x에 대한 z의 미분)은 *∂z/∂t*(t에 대한 z의 미분)과 *∂t/∂x*(x에 대한 t의 미분)의 곱으로 나타낼 수 있다.
-  ex. *z = (x + y)^2* <=> *z = t^2*, *t = x + y*
	- *∂z/∂t = 2t*, *∂t/∂x = 1*
	- *∂z/∂x = (∂z/∂t)×(∂t/∂x) = 2t×1 = 2(x + y)*
### 5.2.3 연쇄법칙과 계산 그래프
![image](https://user-images.githubusercontent.com/61455647/115510075-40d13000-a2ba-11eb-8a69-81940eac6fa4.png)

- 역전파 계산 절차에서 (노드로 들어온 입력 신호) * (그 노드의 국소적 미분(편미분))을 다음 노드로 전달
	- ex. [**2] 노드에서 역전파
		- input: *∂z/∂z = 1*, 국소적 미분: *∂z/∂t*(∵ 순전파 시에 입력이 *t*, 출력이 *z*)
	- 가장 왼쪽의 역전파: *(∂z/∂z)(∂z/∂t)(∂t/∂x) = (∂z/∂t)(∂t/∂x) = (∂z/∂x)* = x에 대한 z의 미분
- => 역전파가 하는 일 = 연쇄법칙의 원리
![image](https://user-images.githubusercontent.com/61455647/115513306-e20db580-a2bd-11eb-9e32-d736a91eb4cf.png)

- 앞선 예시를 계산 그래프의 역전파 결과에 따르면 *∂z/∂x = 2(x+y)* 이다.

## 5.3 역전파
### 5.3.1 덧셈 노드의 역전파

![image](https://user-images.githubusercontent.com/61455647/115514548-2baad000-a2bf-11eb-95cc-6297e4011f53.png)

- *z = x + y*의 미분은 다음과 같이 계산할 수 있다.
	- *∂z/∂x = ∂z/∂y = 1*
- 덧셈 노드의 역전파는 입력 값을 그대로 흘려보낸다.

![image](https://user-images.githubusercontent.com/61455647/115515757-66613800-a2c0-11eb-9a8b-5890c36043b5.png)

- 최종 출력으로 가는 계산의 중간에 덧셈 노드가 존재한다. 역전파에서는 국소적 미분이 가장 오른쪽의 출력에서 시작하며 노드를 타고 왼쪽으로 전파된다.

![image](https://user-images.githubusercontent.com/61455647/115516423-0d45d400-a2c1-11eb-8661-4243387cd05f.png)

- 덧셈 노드의 역전파는 입력 신호를 다음 노드로 출력
- 위의 그림처럼 1.3을 그대로 다음 노드로 전달

### 5.3.2 곱셈 노드의 역전파
- *z = xy*의 미분은 다음과 같이 계산할 수 있다.
	- *∂z/∂x = y*, *∂z/∂y = x*
- 곱셈 노드의 역전파는 상류의 값의 순전파 때의 입력 신호들을 서로 바꾼 값을 곱해 하류로 보낸다.
	- 서로 바꾼 값: 순전파 때 *x*였다면, 역전파에서는 *y*이고, 순전파 때 *y*였으면 역전파에서는 *x*로 바꾼다.
![image](https://user-images.githubusercontent.com/61455647/115516884-87765880-a2c1-11eb-933d-da13dd1679dc.png)

![image](https://user-images.githubusercontent.com/61455647/115518017-b5a86800-a2c2-11eb-871e-48ef6b5589a1.png)

- 곱셈의 역전파는 순방향 입력 신호의 값이 필요 -> 곱셈 노드를 구현할 때 순전파의 입력 신호를 변수에 저장

### 5.3.3 사과 쇼핑의 예
![image](https://user-images.githubusercontent.com/61455647/115519247-fce32880-a2c3-11eb-80e0-8b535c5dfab0.png)

- 이 문제에서 사과의 가격, 사과의 개수, 소비세 세 변수 각각이 최종 금액에 어떻게 영향을 주는가
- = 사과 가격에 대한 지불 금액의 미분(= 2.2), 사과 개수에 대한 지불 금액의 미분(= 110), 소비세에 대한 지불 금액의 미분(= 200) (단, 이 예에서 소비세의 1 = 100%, 사과 가격 1 = 1원으로 단위가 다름)

## 5.4 단순한 계층 구현하기
